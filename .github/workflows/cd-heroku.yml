name: CD Heroku

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      HEROKU_EMAIL: ${{ secrets.HEROKU_EMAIL }}
      HEROKU_APP_BACKEND: ${{ secrets.HEROKU_APP_BACKEND }}
      HEROKU_APP_FRONTEND: ${{ secrets.HEROKU_APP_FRONTEND }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install & auth Heroku CLI
        uses: heroku/actions/setup@v2
        with:
          heroku-api-key: ${{ env.HEROKU_API_KEY }}

      # Optional first run: verify case-sensitive paths on Linux runner
      - name: Sanity check paths
        run: |
          pwd && ls -la
          ls -la Backend || true
          ls -la Backend/fastapi_app || true
          ls -la Frontend || true

      - name: Login to Heroku Container Registry
        run: heroku container:login

      # ---------- Backend ----------
      - name: Set container stack (backend)
        run: heroku stack:set container -a $HEROKU_APP_BACKEND

      - name: Build backend image
        run: |
          docker build \
            -f Backend/fastapi_app/Dockerfile \
            -t registry.heroku.com/$HEROKU_APP_BACKEND/web \
            Backend/fastapi_app

      - name: Push backend image
        run: docker push registry.heroku.com/$HEROKU_APP_BACKEND/web

      - name: Release backend
        run: heroku container:release web -a $HEROKU_APP_BACKEND

      - name: Run Alembic migrations
        run: heroku run "alembic upgrade head" -a $HEROKU_APP_BACKEND

      # ---------- Frontend ----------
      - name: Set container stack (frontend)
        run: heroku stack:set container -a $HEROKU_APP_FRONTEND

      - name: Build frontend image
        run: |
          docker build \
            -f Frontend/Dockerfile \
            -t registry.heroku.com/$HEROKU_APP_FRONTEND/web \
            Frontend

      - name: Push frontend image
        run: docker push registry.heroku.com/$HEROKU_APP_FRONTEND/web

      - name: Release frontend
        run: heroku container:release web -a $HEROKU_APP_FRONTEND
