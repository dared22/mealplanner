---
phase: 06-rating-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - Frontend/src/components/questionnaire/ResultsStep.jsx
  - Frontend/src/hooks/useRatings.js
autonomous: true

must_haves:
  truths:
    - "User can like or dislike any meal in their weekly plan"
    - "Like/dislike buttons appear on each meal card"
    - "User can change rating by clicking the other button"
    - "User sees progress toward unlocking personalized plans"
    - "Ratings persist across page refreshes"
  artifacts:
    - path: "Frontend/src/hooks/useRatings.js"
      provides: "Rating state management and API calls"
      exports: ["useRatings"]
    - path: "Frontend/src/components/questionnaire/ResultsStep.jsx"
      provides: "Rating UI on meal cards"
      contains: "ThumbsUp"
  key_links:
    - from: "ResultsStep.jsx"
      to: "useRatings hook"
      via: "hook import and usage"
      pattern: "useRatings"
    - from: "useRatings.js"
      to: "/ratings API"
      via: "fetch call"
      pattern: "fetch.*\/ratings"
---

<objective>
Add rating UI to the meal plan results, allowing users to like/dislike meals and see their progress toward personalized recommendations.

Purpose: Enable users to provide feedback on meals that will be used by the constraint solver to generate personalized plans.

Output:
- useRatings hook for managing rating state and API calls
- Like/dislike buttons on each meal card in ResultsStep
- Progress indicator showing ratings toward personalization threshold
</objective>

<execution_context>
@/Users/pasha/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pasha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-rating-infrastructure/06-01-SUMMARY.md
@Frontend/src/components/questionnaire/ResultsStep.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useRatings hook</name>
  <files>Frontend/src/hooks/useRatings.js</files>
  <action>
Create a new file Frontend/src/hooks/useRatings.js:

```javascript
import { useState, useCallback, useEffect } from 'react';
import { useAuth } from '@clerk/clerk-react';

const API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';

export function useRatings() {
  const { getToken } = useAuth();
  const [ratings, setRatings] = useState({}); // { recipe_id: { is_liked: boolean, id: string } }
  const [progress, setProgress] = useState({ total: 0, threshold: 10, is_unlocked: false });
  const [loading, setLoading] = useState(false);

  // Fetch user's existing ratings on mount
  const fetchRatings = useCallback(async () => {
    try {
      const token = await getToken();
      const res = await fetch(`${API_URL}/ratings/me?limit=100`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (res.ok) {
        const data = await res.json();
        const map = {};
        for (const r of data.items || []) {
          map[r.recipe_id] = { is_liked: r.is_liked, id: r.id };
        }
        setRatings(map);
      }
    } catch (err) {
      console.error('Failed to fetch ratings:', err);
    }
  }, [getToken]);

  // Fetch progress toward personalization
  const fetchProgress = useCallback(async () => {
    try {
      const token = await getToken();
      const res = await fetch(`${API_URL}/ratings/progress`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (res.ok) {
        const data = await res.json();
        setProgress({
          total: data.total_ratings,
          threshold: data.threshold,
          is_unlocked: data.is_unlocked
        });
      }
    } catch (err) {
      console.error('Failed to fetch progress:', err);
    }
  }, [getToken]);

  // Submit a rating (like or dislike)
  const submitRating = useCallback(async (recipeId, isLiked) => {
    if (!recipeId) return;
    setLoading(true);
    try {
      const token = await getToken();
      const res = await fetch(`${API_URL}/ratings`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ recipe_id: recipeId, is_liked: isLiked })
      });
      if (res.ok) {
        const data = await res.json();
        setRatings(prev => ({
          ...prev,
          [recipeId]: { is_liked: data.is_liked, id: data.id }
        }));
        // Increment progress if this is a new rating
        setProgress(prev => {
          const wasRated = prev.total === Object.keys(ratings).length;
          const newTotal = Object.keys({ ...ratings, [recipeId]: true }).length;
          return {
            ...prev,
            total: newTotal,
            is_unlocked: newTotal >= prev.threshold
          };
        });
        // Re-fetch progress for accuracy
        fetchProgress();
      }
    } catch (err) {
      console.error('Failed to submit rating:', err);
    } finally {
      setLoading(false);
    }
  }, [getToken, ratings, fetchProgress]);

  // Get rating for a specific recipe
  const getRating = useCallback((recipeId) => {
    return ratings[recipeId] || null;
  }, [ratings]);

  useEffect(() => {
    fetchRatings();
    fetchProgress();
  }, [fetchRatings, fetchProgress]);

  return {
    ratings,
    progress,
    loading,
    submitRating,
    getRating,
    refetch: () => { fetchRatings(); fetchProgress(); }
  };
}
```

This hook provides:
- ratings: Map of recipe_id to rating info
- progress: Current count toward threshold
- submitRating(recipeId, isLiked): Create/update rating
- getRating(recipeId): Check if recipe is rated
  </action>
  <verify>
File exists and exports useRatings: grep -l "export function useRatings" Frontend/src/hooks/useRatings.js
  </verify>
  <done>
useRatings hook created with state management for ratings and progress, API integration for submit/fetch.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rating buttons to MealItem component</name>
  <files>Frontend/src/components/questionnaire/ResultsStep.jsx</files>
  <action>
Modify ResultsStep.jsx to add like/dislike buttons:

1. **Add imports at top:**
   ```javascript
   import { ThumbsUp, ThumbsDown } from 'lucide-react';
   import { useRatings } from '@/hooks/useRatings';
   ```

2. **Add rating state in ResultsStep component:**
   After the existing hooks, add:
   ```javascript
   const { progress, submitRating, getRating, loading: ratingLoading } = useRatings();
   ```

3. **Modify MealItem component to accept rating props:**
   Update the MealItem memo function signature to accept: meal, mealType, onSwap, t, recipeRating, onRate, ratingDisabled

4. **Add rating buttons in MealItem after the swap button:**
   ```jsx
   {meal.id && (
     <div className="flex gap-1 ml-2">
       <button
         onClick={() => onRate(meal.id, true)}
         disabled={ratingDisabled}
         className={`meal-action ${recipeRating?.is_liked === true ? 'text-green-500' : ''}`}
         title={t('Like this meal')}
       >
         <ThumbsUp className={`w-4 h-4 ${recipeRating?.is_liked === true ? 'fill-current' : ''}`} />
       </button>
       <button
         onClick={() => onRate(meal.id, false)}
         disabled={ratingDisabled}
         className={`meal-action ${recipeRating?.is_liked === false ? 'text-red-500' : ''}`}
         title={t('Dislike this meal')}
       >
         <ThumbsDown className={`w-4 h-4 ${recipeRating?.is_liked === false ? 'fill-current' : ''}`} />
       </button>
     </div>
   )}
   ```

5. **Update MealItem usage in the render:**
   Where MealItem is rendered, pass the new props:
   ```jsx
   <MealItem
     key={`${selectedDay.name}-${mealType}`}
     meal={selectedDay.meals[mealType]}
     mealType={mealType}
     onSwap={() => handleSwap(selectedDayIndex, mealType)}
     t={t}
     recipeRating={getRating(selectedDay.meals[mealType]?.id)}
     onRate={submitRating}
     ratingDisabled={ratingLoading}
   />
   ```

6. **Add CSS for rating button states:**
   The buttons use existing meal-action class. Add visual feedback via Tailwind classes:
   - Active like: text-green-500 fill-current
   - Active dislike: text-red-500 fill-current
  </action>
  <verify>
Check imports: grep -l "ThumbsUp" Frontend/src/components/questionnaire/ResultsStep.jsx
Check hook usage: grep -l "useRatings" Frontend/src/components/questionnaire/ResultsStep.jsx
  </verify>
  <done>
Like/dislike buttons appear on each meal card with visual feedback for current rating state.
Buttons call submitRating on click and show loading state while submitting.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add progress indicator for personalization</name>
  <files>Frontend/src/components/questionnaire/ResultsStep.jsx</files>
  <action>
Add a progress indicator showing how many ratings are needed to unlock personalized plans:

1. **Create RatingProgress component inside ResultsStep.jsx (before export):**
   ```jsx
   const RatingProgress = memo(function RatingProgress({ progress, t }) {
     const translate = t || ((v) => v);
     const remaining = Math.max(progress.threshold - progress.total, 0);

     if (progress.is_unlocked) {
       return (
         <div className="p-4 rounded-xl bg-green-50 dark:bg-green-950/20 border border-green-200 dark:border-green-900">
           <div className="flex items-center gap-2">
             <CheckCircle className="w-5 h-5 text-green-600" />
             <span className="text-sm font-medium text-green-800 dark:text-green-200">
               {translate('Personalized plans unlocked!')}
             </span>
           </div>
           <p className="mt-1 text-xs text-green-600 dark:text-green-400">
             {translate('Your next plan will be tailored to your preferences.')}
           </p>
         </div>
       );
     }

     const percentage = Math.min((progress.total / progress.threshold) * 100, 100);

     return (
       <div className="p-4 rounded-xl bg-accent border border-border">
         <div className="flex items-center justify-between mb-2">
           <span className="text-sm font-medium text-foreground">
             {translate('Unlock Personalized Plans')}
           </span>
           <span className="text-xs text-muted-foreground">
             {progress.total}/{progress.threshold}
           </span>
         </div>
         <div className="h-2 bg-secondary rounded-full overflow-hidden">
           <div
             className="h-full bg-primary transition-all duration-300"
             style={{ width: `${percentage}%` }}
           />
         </div>
         <p className="mt-2 text-xs text-muted-foreground">
           {remaining > 0
             ? translate('{count} more ratings to unlock', { count: remaining })
             : translate('Almost there!')}
         </p>
       </div>
     );
   });
   ```

2. **Add RatingProgress to the Day Summary sidebar:**
   After the "Day Summary" card (around line 595-613), add:
   ```jsx
   <RatingProgress progress={progress} t={t} />
   ```

3. **Add translation keys (these will fall back gracefully):**
   - "Personalized plans unlocked!"
   - "Your next plan will be tailored to your preferences."
   - "Unlock Personalized Plans"
   - "{count} more ratings to unlock"
   - "Almost there!"
   - "Like this meal"
   - "Dislike this meal"
  </action>
  <verify>
Check component exists: grep -l "RatingProgress" Frontend/src/components/questionnaire/ResultsStep.jsx
Check progress usage: grep -l "progress.threshold" Frontend/src/components/questionnaire/ResultsStep.jsx
  </verify>
  <done>
Progress bar shows current rating count vs threshold (10).
Message updates to show remaining ratings needed.
Visual celebration when personalization is unlocked.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. useRatings hook exports correctly
2. ResultsStep imports ThumbsUp, ThumbsDown, useRatings
3. MealItem shows rating buttons with correct styling
4. RatingProgress component renders progress bar
5. No ESLint errors in modified files

Integration test (manual):
- Load a meal plan in the browser
- Click thumbs up on a meal - should show green fill
- Click thumbs down on same meal - should switch to red fill
- Progress bar should increment
</verification>

<success_criteria>
- Like/dislike buttons visible on every meal card that has a recipe ID (RATE-02)
- Clicking like/dislike immediately updates UI (optimistic) (RATE-03)
- User can change rating by clicking other button (RATE-04)
- Progress indicator shows X/10 ratings toward personalization (RATE-06)
- Ratings persist after page refresh (DATA-01 via backend)
- No console errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/06-rating-infrastructure/06-02-SUMMARY.md`
</output>
