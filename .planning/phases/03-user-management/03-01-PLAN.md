---
phase: 03-user-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Backend/fastapi_app/models.py
  - Backend/fastapi_app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin can request a paginated user list with search and signup date filters"
    - "Admin can suspend or reactivate a user account"
    - "Suspended users receive a 403 when accessing authenticated endpoints"
  artifacts:
    - path: "Backend/fastapi_app/models.py"
      provides: "User.is_active status flag with default true"
      contains: "is_active"
    - path: "Backend/fastapi_app/main.py"
      provides: "Admin user management endpoints and status enforcement"
      exports: ["GET /admin/users", "GET /admin/users/{user_id}", "PATCH /admin/users/{user_id}/status"]
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "User.is_active"
      via: "current_user_dependency check"
      pattern: "is_active"
    - from: "Backend/fastapi_app/main.py"
      to: "admin_user_dependency"
      via: "Depends"
      pattern: "admin_user_dependency"
---

<objective>
Add backend support for admin user management, including account suspension enforcement.

Purpose: Enable core user management workflows and ensure suspended users are blocked at auth.
Output: User status field plus admin-only list/detail/status endpoints.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Backend/fastapi_app/models.py
@Backend/fastapi_app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user active status and enforce suspended access</name>
  <files>Backend/fastapi_app/models.py, Backend/fastapi_app/main.py</files>
  <action>
Add an `is_active` boolean column to the User model with `default=True` and `server_default="true"`.
Update `current_user_dependency` to raise HTTP 403 "Account suspended" when `user.is_active` is false.
Ensure admin endpoints inherit this behavior via the existing dependency chain.
  </action>
  <verify>Backend/fastapi_app/main.py contains a 403 check for inactive users and models.py defines is_active.</verify>
  <done>Suspended users are blocked from authenticated routes by the shared dependency.</done>
</task>

<task type="auto">
  <name>Task 2: Implement admin user list, detail, and status endpoints</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
Add Pydantic response models for admin user summaries, pagination metadata, and user detail payloads.
Implement `GET /admin/users` with `search`, `start_date`, `end_date`, `limit`, and `offset` query params:
- Search matches username or email case-insensitively.
- Date range filters use `User.created_at` and normalize naive datetimes to UTC.
- Response includes `items` and `pagination` (total, limit, offset).
Implement `GET /admin/users/{user_id}` returning user profile plus preference history, including each preference's raw_data and derived plan status.
Implement `PATCH /admin/users/{user_id}/status` with a body `{"is_active": boolean}` to suspend/reactivate and return the updated summary.
Protect all admin endpoints with `admin_user_dependency`.
  </action>
  <verify>curl -H "Authorization: Bearer $ADMIN_TOKEN" "$API_URL/admin/users?limit=1" returns 200 and includes pagination.</verify>
  <done>Admin can list users, view detail payloads, and toggle is_active via admin-only routes.</done>
</task>

</tasks>

<verification>
- `curl -H "Authorization: Bearer $ADMIN_TOKEN" "$API_URL/admin/users?limit=1"` returns items + pagination.
- `curl -H "Authorization: Bearer $ADMIN_TOKEN" "$API_URL/admin/users/{user_id}"` includes preferences and raw_data.
- `curl -X PATCH -H "Authorization: Bearer $ADMIN_TOKEN" -H "Content-Type: application/json" -d '{"is_active": false}' "$API_URL/admin/users/{user_id}/status"` returns `is_active: false`.
</verification>

<success_criteria>
Admin-only user management endpoints work end-to-end and suspended accounts are rejected by auth dependencies.
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-management/03-01-SUMMARY.md`
</output>
