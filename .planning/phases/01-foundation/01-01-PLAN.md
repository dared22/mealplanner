---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Backend/fastapi_app/models.py
  - Backend/fastapi_app/main.py
autonomous: true

must_haves:
  truths:
    - "Backend returns is_admin status for authenticated users"
    - "Admin-only endpoints reject non-admin users with 403"
    - "Non-authenticated requests to admin endpoints return 401"
  artifacts:
    - path: "Backend/fastapi_app/models.py"
      provides: "is_admin boolean column on User model"
      contains: "is_admin"
    - path: "Backend/fastapi_app/main.py"
      provides: "admin_user_dependency and /admin/session endpoint"
      contains: "admin_user_dependency"
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "Backend/fastapi_app/models.py"
      via: "admin_user_dependency checks User.is_admin"
      pattern: "user\\.is_admin"
---

<objective>
Add is_admin field to User model and create backend admin authentication infrastructure.

Purpose: Backend must distinguish admin users from regular users and protect admin-only endpoints. This is the foundation that both frontend admin guard and all future admin API endpoints depend on.
Output: User model with is_admin column, admin_user_dependency for route protection, /admin/session endpoint returning admin user info.
</objective>

<execution_context>
@/Users/pasha/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pasha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@Backend/fastapi_app/models.py
@Backend/fastapi_app/main.py
@Backend/fastapi_app/clerk_auth.py
@Backend/fastapi_app/database.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add is_admin field to User model</name>
  <files>Backend/fastapi_app/models.py</files>
  <action>
Add an `is_admin` boolean column to the User model in models.py:

```python
is_admin: Mapped[bool] = mapped_column(Boolean, default=False, nullable=False, server_default="false")
```

Place it after the `created_at` field and before the `preferences` relationship. Use `server_default="false"` so existing rows get FALSE without a data migration. The column uses SQLAlchemy Boolean type which is already imported in the file.
  </action>
  <verify>
Run `python -c "from models import User; print(hasattr(User, 'is_admin'))"` from Backend/fastapi_app/ directory to confirm the attribute exists on the model. The import should succeed without errors.
  </verify>
  <done>User model has is_admin boolean column with default=False and server_default="false".</done>
</task>

<task type="auto">
  <name>Task 2: Create admin auth dependency and /admin/session endpoint</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
Add two things to main.py:

1. **admin_user_dependency function** - Place it right after the existing `current_user_dependency` function (around line 92). This dependency reuses `current_user_dependency` and adds an is_admin check:

```python
def admin_user_dependency(
    user: User = Depends(current_user_dependency),
) -> User:
    if not user.is_admin:
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN, detail="Admin access required")
    return user
```

2. **GET /admin/session endpoint** - Place it after the existing `/auth/session` endpoint. This endpoint uses the admin dependency to verify the caller is an admin and returns their session info:

```python
class AdminSessionResponse(BaseModel):
    user_id: UUID
    clerk_user_id: str
    email: Optional[EmailStr] = None
    username: str
    is_admin: bool

@app.get("/admin/session", response_model=AdminSessionResponse)
def get_admin_session(user: User = Depends(admin_user_dependency)) -> AdminSessionResponse:
    return AdminSessionResponse(
        user_id=user.id,
        clerk_user_id=user.clerk_user_id or "",
        email=user.email,
        username=user.username,
        is_admin=user.is_admin,
    )
```

Import UUID is already available. The AdminSessionResponse model extends the pattern of the existing SessionResponse but adds is_admin. Do NOT modify the existing SessionResponse or /auth/session endpoint - they serve the regular user flow.
  </action>
  <verify>
1. Check that the app module loads without syntax errors: `cd Backend/fastapi_app && python -c "from main import app; print('OK')"` (this may fail if DATABASE_URL is not set, which is acceptable - the import structure is what matters).
2. Grep to confirm the admin dependency exists: search for "admin_user_dependency" in main.py.
3. Grep to confirm the endpoint exists: search for "/admin/session" in main.py.
  </verify>
  <done>
- admin_user_dependency function exists and raises 403 if user.is_admin is False
- GET /admin/session endpoint exists, protected by admin_user_dependency, returns AdminSessionResponse with is_admin field
- Non-admin users calling /admin/session get 403 "Admin access required"
- Non-authenticated users get 401 "Not authenticated"
  </done>
</task>

</tasks>

<verification>
1. User model has is_admin: Mapped[bool] column with server_default="false"
2. admin_user_dependency function exists in main.py and raises HTTPException(403) for non-admin users
3. GET /admin/session endpoint exists and returns admin user data
4. Existing endpoints (/auth/session, /preferences, etc.) are not modified
5. No import errors in either modified file
</verification>

<success_criteria>
- is_admin column added to User model with safe defaults for existing data
- admin_user_dependency reusable for all future admin endpoints
- /admin/session endpoint returns admin status, rejects non-admins with 403
- Existing user-facing code unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
