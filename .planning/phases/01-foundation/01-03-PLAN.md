---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - Frontend/src/App.jsx
  - Frontend/src/components/admin/AdminGuard.jsx
  - Frontend/src/Pages/AdminDashboard.jsx
  - Frontend/src/Pages/AdminUsers.jsx
  - Frontend/src/Pages/AdminRecipes.jsx
  - Frontend/src/Pages/AdminLogs.jsx
autonomous: false

must_haves:
  truths:
    - "Admin user navigating to /admin sees the admin panel with sidebar and header"
    - "Non-admin user navigating to /admin sees the 403 Forbidden page"
    - "Admin panel routes render inside AdminLayout with correct active section"
    - "Admin name appears in the header from the backend session data"
    - "Clicking sidebar nav items navigates between admin sections"
  artifacts:
    - path: "Frontend/src/components/admin/AdminGuard.jsx"
      provides: "Auth guard that checks /admin/session and routes to 403 or admin panel"
      min_lines: 30
    - path: "Frontend/src/App.jsx"
      provides: "Admin routes under /admin/* path"
      contains: "/admin"
    - path: "Frontend/src/Pages/AdminDashboard.jsx"
      provides: "Placeholder dashboard page for admin panel"
      min_lines: 10
  key_links:
    - from: "Frontend/src/components/admin/AdminGuard.jsx"
      to: "/admin/session"
      via: "fetch call to backend API"
      pattern: "fetch.*admin/session"
    - from: "Frontend/src/App.jsx"
      to: "Frontend/src/components/admin/AdminGuard.jsx"
      via: "Route element wrapping admin routes"
      pattern: "AdminGuard"
    - from: "Frontend/src/components/admin/AdminGuard.jsx"
      to: "Frontend/src/components/admin/AdminLayout.jsx"
      via: "Renders AdminLayout when admin verified"
      pattern: "AdminLayout"
    - from: "Frontend/src/components/admin/AdminGuard.jsx"
      to: "Frontend/src/Pages/Forbidden.jsx"
      via: "Renders Forbidden when not admin"
      pattern: "Forbidden"
---

<objective>
Wire admin routes into the frontend router with an auth guard that checks admin status via the backend API.

Purpose: This connects the backend admin auth (Plan 01) with the frontend admin layout (Plan 02) to create the complete admin access flow. The AdminGuard component calls GET /admin/session - if it returns 200, the user is an admin and sees the panel; if 403, they see the Forbidden page.
Output: AdminGuard component, admin routes in App.jsx, placeholder admin section pages.
</objective>

<execution_context>
@/Users/pasha/.claude/get-shit-done/workflows/execute-plan.md
@/Users/pasha/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

@Frontend/src/App.jsx
@Frontend/src/Entities/api.js
@Frontend/src/components/admin/AdminLayout.jsx
@Frontend/src/Pages/Forbidden.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminGuard component and placeholder admin pages</name>
  <files>
    Frontend/src/components/admin/AdminGuard.jsx
    Frontend/src/Pages/AdminDashboard.jsx
    Frontend/src/Pages/AdminUsers.jsx
    Frontend/src/Pages/AdminRecipes.jsx
    Frontend/src/Pages/AdminLogs.jsx
  </files>
  <action>
**AdminGuard.jsx:**
Create `Frontend/src/components/admin/AdminGuard.jsx`:

- Default export: `AdminGuard()` component
- On mount, call `GET {API_URL}/admin/session` with the Clerk session token in the Authorization header
- Use `useAuth()` from `@clerk/clerk-react` to get `getToken` function for retrieving the session token
- State: `status` ("loading" | "authorized" | "forbidden" | "error"), `adminData` (object with username, email, is_admin)
- Flow:
  1. On mount, set status="loading"
  2. Call `const token = await getToken()` then `fetch(API_URL + "/admin/session", { headers: { Authorization: "Bearer " + token } })`
  3. If response.ok (200): set adminData from response JSON, set status="authorized"
  4. If response.status === 403: set status="forbidden"
  5. If response.status === 401 or network error: set status="error" (treat as forbidden for display)
- Render based on status:
  - "loading": Show a centered spinner or "Loading..." text (simple div with animate-spin or text)
  - "authorized": Render `<AdminLayout adminName={adminData.username} onLogout={handleLogout}>` with `<Outlet />` from react-router-dom inside it
  - "forbidden" or "error": Render `<Forbidden />`
- Import `Outlet` from react-router-dom (this allows nested routes to render inside the layout)
- Import `API_URL` from `@/Entities/api`
- Import `useAuth` from `@clerk/clerk-react`
- `handleLogout`: Use Clerk's `signOut` from `useAuth()` or navigate to "/" - use `const { getToken, signOut } = useAuth()` and call `signOut()` then navigate to "/"
- Use `useEffect` for the admin session check, with appropriate cleanup (ignore stale responses if component unmounts)

**Placeholder admin pages** (4 files):
Create minimal placeholder pages that will be replaced in future phases:

`Frontend/src/Pages/AdminDashboard.jsx`:
```jsx
export default function AdminDashboard() {
  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Dashboard</h1>
      <p className="text-muted-foreground">Dashboard analytics will appear here.</p>
    </div>
  )
}
```

`Frontend/src/Pages/AdminUsers.jsx`:
```jsx
export default function AdminUsers() {
  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">User Management</h1>
      <p className="text-muted-foreground">User management tools will appear here.</p>
    </div>
  )
}
```

`Frontend/src/Pages/AdminRecipes.jsx`:
```jsx
export default function AdminRecipes() {
  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Recipe Database</h1>
      <p className="text-muted-foreground">Recipe management tools will appear here.</p>
    </div>
  )
}
```

`Frontend/src/Pages/AdminLogs.jsx`:
```jsx
export default function AdminLogs() {
  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Activity Logs</h1>
      <p className="text-muted-foreground">System activity logs will appear here.</p>
    </div>
  )
}
```
  </action>
  <verify>
1. All 5 files exist: `ls Frontend/src/components/admin/AdminGuard.jsx Frontend/src/Pages/Admin*.jsx`
2. AdminGuard fetches /admin/session: grep for "admin/session" in AdminGuard.jsx
3. AdminGuard renders Forbidden on 403: grep for "Forbidden" in AdminGuard.jsx
4. AdminGuard renders AdminLayout + Outlet on success: grep for "AdminLayout" and "Outlet" in AdminGuard.jsx
5. AdminGuard uses Clerk auth: grep for "useAuth" or "getToken" in AdminGuard.jsx
  </verify>
  <done>
- AdminGuard checks admin status via GET /admin/session with Clerk token
- Authorized admins see AdminLayout with Outlet for nested routes
- Non-admins see Forbidden page
- Four placeholder admin section pages exist
  </done>
</task>

<task type="auto">
  <name>Task 2: Add admin routes to App.jsx</name>
  <files>Frontend/src/App.jsx</files>
  <action>
Modify `Frontend/src/App.jsx` to add admin routes inside the existing `SignedIn` block:

1. Add imports at top:
```jsx
import AdminGuard from '@/components/admin/AdminGuard'
import AdminDashboard from '@/Pages/AdminDashboard'
import AdminUsers from '@/Pages/AdminUsers'
import AdminRecipes from '@/Pages/AdminRecipes'
import AdminLogs from '@/Pages/AdminLogs'
import Forbidden from '@/Pages/Forbidden'
```

2. Inside the `<SignedIn>` block's `<Routes>`, add admin routes BEFORE the existing routes (so they match first):
```jsx
<Route path="/admin" element={<AdminGuard />}>
  <Route index element={<AdminDashboard />} />
  <Route path="users" element={<AdminUsers />} />
  <Route path="recipes" element={<AdminRecipes />} />
  <Route path="logs" element={<AdminLogs />} />
</Route>
<Route path="/forbidden" element={<Forbidden />} />
```

The `/admin` parent route uses `AdminGuard` as its element. AdminGuard renders `<Outlet />` when authorized, which renders the child routes (index=AdminDashboard, users, recipes, logs). This is React Router's nested route pattern.

Keep ALL existing routes unchanged (`/`, `/planner`, `/recipes`, `/groceries`). The admin routes are additive.

Do NOT wrap admin routes in DashboardLayout - they use their own AdminLayout (rendered by AdminGuard).
  </action>
  <verify>
1. App.jsx contains admin route: grep for "/admin" in App.jsx
2. App.jsx imports AdminGuard: grep for "AdminGuard" in App.jsx
3. App.jsx still has existing routes: grep for "/planner" in App.jsx
4. Frontend builds without errors: `cd Frontend && npx vite build --mode development 2>&1 | tail -10`
  </verify>
  <done>
- /admin route exists with AdminGuard wrapper
- Nested routes: /admin (dashboard), /admin/users, /admin/recipes, /admin/logs
- /forbidden route exists for direct access
- All existing user-facing routes unchanged
- Frontend builds without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin panel foundation: backend admin auth, frontend layout with sidebar/header, routing with auth guard, and 403 page. An admin user should see the admin panel at /admin. A non-admin user should see the 403 page.</what-built>
  <how-to-verify>
1. Start the backend: `cd Backend/fastapi_app && uvicorn main:app --reload --port 8000`
2. Start the frontend: `cd Frontend && npm run dev`
3. Before testing, ensure at least one user has is_admin=TRUE in the database. You can set this via SQL:
   `UPDATE users SET is_admin = true WHERE email = 'YOUR_ADMIN_EMAIL';`
   (Or use the MCP neon-db tools to execute this)
4. Log in as the admin user and navigate to http://localhost:5173/admin
5. Verify you see:
   - Left sidebar with 4 navigation items (Dashboard, User Management, Recipe Database, Activity Logs)
   - Header bar with your username, search bar, and logout button
   - "Dashboard" section shown as the default content
   - Clicking sidebar items navigates between sections
   - Active section is highlighted in the sidebar
6. Log in as a non-admin user (or test with a user that has is_admin=false) and navigate to /admin
7. Verify you see the 403 Forbidden page with "Access Denied" message and "Return to Home" link
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Backend: is_admin column exists on User model
2. Backend: admin_user_dependency raises 403 for non-admins
3. Backend: GET /admin/session returns admin data for admins, 403 for others
4. Frontend: AdminGuard calls /admin/session and gates access
5. Frontend: AdminLayout renders sidebar + header + content
6. Frontend: Admin routes /admin, /admin/users, /admin/recipes, /admin/logs all work
7. Frontend: Non-admin users see 403 page
8. Frontend: Sidebar highlights active section
9. Frontend: Existing user routes unchanged
</verification>

<success_criteria>
- Admin with is_admin=TRUE sees full admin panel at /admin with sidebar, header, and content
- Non-admin sees 403 Forbidden page at /admin
- Sidebar navigation works between all 4 sections with active highlighting
- Header shows admin name, search bar, and logout button
- All existing user-facing app routes continue to work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
