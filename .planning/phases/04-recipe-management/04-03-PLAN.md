---
phase: 04-recipe-management
plan: 03
type: execute
wave: 3
depends_on:
  - 04-02
files_modified:
  - Backend/fastapi_app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin can bulk import recipes from CSV or Parquet files"
    - "Import responses report created/updated/skipped counts and errors"
  artifacts:
    - path: "Backend/fastapi_app/main.py"
      provides: "Admin recipe bulk import endpoint and parsing helpers"
      exports:
        - "POST /admin/recipes/import"
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "Recipe model"
      via: "bulk upsert"
      pattern: "db\\.add\\(|db\\.commit\\(\)"
---

<objective>
Create an admin bulk import endpoint for CSV/Parquet recipe files.

Purpose: Enable fast recipe ingestion without manual entry.
Output: Import endpoint that parses files and upserts recipes by slug.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Backend/fastapi_app/main.py
@Backend/fastapi_app/planner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bulk import parsing helpers and response model</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
    Add helpers to:
    - detect format (CSV vs Parquet) using Content-Type and optional X-File-Name header
    - parse CSV (pandas.read_csv) and Parquet (pandas.read_parquet) from request body bytes
    - normalize columns for title/name, ingredients, instructions, nutrition, tags, meal_type
    - parse list-like fields from JSON strings, comma-separated values, or newline-separated values
    - generate slug from title with uniqueness check (reuse helper from plan 04-01)
    Define a response model (e.g., AdminRecipeImportResponse) with created/updated/skipped/error counts and sample errors.
  </action>
  <verify>
    python - <<'PY'
import pandas as pd
print(pd.DataFrame([{"title":"Test","ingredients":"egg"}]).to_dict("records"))
PY
  </verify>
  <done>
    Parsing helpers convert CSV/Parquet rows into normalized recipe payloads and a response model exists for import results.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement /admin/recipes/import endpoint with upsert</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
    Implement POST /admin/recipes/import guarded by admin_user_dependency.
    - Read raw request body bytes (no multipart) and infer format
    - For each row: build a normalized payload (title, ingredients, instructions, nutrition, tags, meal_type)
    - Upsert by slug: update existing recipe fields if slug exists; otherwise create new recipe with uuid4 id
    - Track counts (created/updated/skipped) and collect parsing errors (cap list to avoid huge responses)
    - Return AdminRecipeImportResponse with counts and errors
  </action>
  <verify>
    curl -X POST -H "Authorization: Bearer $ADMIN_TOKEN" -H "Content-Type: text/csv" \
      -H "X-File-Name: recipes.csv" --data-binary @/path/to/recipes.csv \
      "$API_URL/admin/recipes/import" | jq '.created'
  </verify>
  <done>
    Import endpoint accepts CSV/Parquet uploads and returns counts for created/updated/skipped recipes.
  </done>
</task>

</tasks>

<verification>
Bulk import endpoint processes a CSV/Parquet payload and reports counts without raising errors for valid files.
</verification>

<success_criteria>
Admins can POST a CSV/Parquet file to /admin/recipes/import and receive a structured summary of the import results.
</success_criteria>

<output>
After completion, create `.planning/phases/04-recipe-management/04-03-SUMMARY.md`
</output>
