---
phase: 04-recipe-management
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - Backend/fastapi_app/main.py
  - Backend/fastapi_app/planner.py
autonomous: true

must_haves:
  truths:
    - "Admin can delete a recipe and it becomes inactive"
    - "Inactive recipes are excluded from public recipe listing"
    - "Inactive recipes are excluded from meal plan generation"
  artifacts:
    - path: "Backend/fastapi_app/main.py"
      provides: "Admin recipe delete endpoint and active-only public listing"
      exports:
        - "DELETE /admin/recipes/{recipe_id}"
        - "GET /recipes (active-only)"
    - path: "Backend/fastapi_app/planner.py"
      provides: "Active-only recipe selection for meal plans"
      contains: "_load_recipes_df"
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "Recipe.is_active"
      via: "soft delete update"
      pattern: "is_active\\s*=\\s*False"
    - from: "Backend/fastapi_app/planner.py"
      to: "Recipe.is_active"
      via: "WHERE filter"
      pattern: "Recipe\\.is_active"
---

<objective>
Add soft delete support and ensure inactive recipes are excluded from user-facing flows.

Purpose: Meet delete requirements without breaking meal plan generation or public listings.
Output: Admin delete endpoint and active-only filters in recipe queries.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Backend/fastapi_app/main.py
@Backend/fastapi_app/planner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin recipe delete endpoint (soft delete)</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
    Implement DELETE /admin/recipes/{recipe_id} guarded by admin_user_dependency.
    - Fetch recipe by id, return 404 if missing
    - Set is_active = False and updated_at = datetime.now(timezone.utc)
    - Return AdminRecipeSummary or AdminRecipeDetail with is_active=false
    - Allow idempotent deletes (already inactive still returns 200)
  </action>
  <verify>
    curl -X DELETE -H "Authorization: Bearer $ADMIN_TOKEN" "$API_URL/admin/recipes/$RECIPE_ID" | jq '.is_active'
  </verify>
  <done>
    Delete endpoint marks the recipe inactive and returns a payload reflecting is_active=false.
  </done>
</task>

<task type="auto">
  <name>Task 2: Filter inactive recipes out of public and planner queries</name>
  <files>Backend/fastapi_app/main.py, Backend/fastapi_app/planner.py</files>
  <action>
    Update GET /recipes to include Recipe.is_active == True in its base query.
    Update planner._load_recipes_df to select only active recipes so meal plan generation ignores inactive records.
    Keep admin list endpoints unaffected unless a filter param is explicitly provided.
  </action>
  <verify>
    curl "$API_URL/recipes?search=Admin%20Test%20Recipe" | jq '.items | length'
  </verify>
  <done>
    Inactive recipes no longer appear in public recipe lists or meal plan generation inputs.
  </done>
</task>

</tasks>

<verification>
Soft-deleted recipes stay visible to admins but are excluded from public listing and planner selection.
</verification>

<success_criteria>
DELETE /admin/recipes/{id} performs soft delete and inactive recipes are filtered out by /recipes and planner._load_recipes_df.
</success_criteria>

<output>
After completion, create `.planning/phases/04-recipe-management/04-02-SUMMARY.md`
</output>
