---
phase: 04-recipe-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Backend/fastapi_app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin can fetch a paginated recipe list with search by name or tags"
    - "Admin can view a recipe detail payload suitable for editing"
    - "Admin can create and update recipes with required fields"
  artifacts:
    - path: "Backend/fastapi_app/main.py"
      provides: "Admin recipe list/detail and create/update endpoints"
      exports:
        - "GET /admin/recipes"
        - "GET /admin/recipes/{recipe_id}"
        - "POST /admin/recipes"
        - "PATCH /admin/recipes/{recipe_id}"
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "Recipe model"
      via: "select/insert/update queries"
      pattern: "Recipe\\.title|select\\(Recipe\\)|db\\.add\\(recipe"
---

<objective>
Add admin recipe list/detail and create/update endpoints.

Purpose: Provide the backend CRUD foundation for recipe management.
Output: Admin endpoints and response models for listing, viewing, creating, and updating recipes.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Backend/fastapi_app/main.py
@Backend/fastapi_app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin recipe models and list/detail endpoints</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
    Define Pydantic models for admin recipe responses (summary + detail) and pagination metadata, mirroring the admin user list pattern.
    Implement GET /admin/recipes with query params:
    - search (string): matches Recipe.title OR Recipe.tags array values (case-insensitive)
    - limit, offset (pagination; default 50, max 100)
    - active (optional bool): when provided, filters on Recipe.is_active
    Return items + pagination fields (total, limit, offset) and include is_active in each item.
    Implement GET /admin/recipes/{recipe_id} returning full recipe payload for editing.
    Guard both endpoints with admin_user_dependency and reuse _json_safe for serialization.
  </action>
  <verify>
    curl -H "Authorization: Bearer $ADMIN_TOKEN" "$API_URL/admin/recipes?search=chicken&limit=5" | jq '.items | length'
    curl -H "Authorization: Bearer $ADMIN_TOKEN" "$API_URL/admin/recipes/$RECIPE_ID" | jq '.id'
  </verify>
  <done>
    List endpoint returns items + pagination with title/tags/is_active, and detail endpoint returns full recipe payload for a valid id.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin recipe create/update endpoints</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
    Add AdminRecipeCreate (required fields: title, ingredients, instructions, nutrition, tags, meal_type) and AdminRecipeUpdate (all optional) models.
    Implement POST /admin/recipes to create a recipe:
    - generate UUID id and slug from title (slugified lowercase, dash-separated)
    - ensure slug uniqueness by appending a short suffix if needed
    - store provided fields into Recipe columns and set is_active=true
    Implement PATCH /admin/recipes/{recipe_id} to update only provided fields:
    - if title changes and slug not provided, regenerate slug with uniqueness check (exclude current record)
    - set updated_at = datetime.now(timezone.utc)
    Return the updated AdminRecipeDetail payload.
  </action>
  <verify>
    curl -X POST -H "Authorization: Bearer $ADMIN_TOKEN" -H "Content-Type: application/json" \
      -d '{"title":"Admin Test Recipe","ingredients":["1 cup rice"],"instructions":["Cook"],"nutrition":{"calories":400},"tags":["test"],"meal_type":"dinner"}' \
      "$API_URL/admin/recipes" | jq '.id'
    curl -X PATCH -H "Authorization: Bearer $ADMIN_TOKEN" -H "Content-Type: application/json" \
      -d '{"title":"Admin Test Recipe Updated"}' \
      "$API_URL/admin/recipes/$RECIPE_ID" | jq '.title'
  </verify>
  <done>
    Admin can create recipes with required fields and update existing recipes, with slug generation and updated_at tracking working.
  </done>
</task>

</tasks>

<verification>
Admin recipe list/detail/create/update endpoints return expected payloads when called with valid admin auth.
</verification>

<success_criteria>
GET /admin/recipes supports search + pagination, GET /admin/recipes/{id} returns full payload, and POST/PATCH persist recipe changes.
</success_criteria>

<output>
After completion, create `.planning/phases/04-recipe-management/04-01-SUMMARY.md`
</output>
