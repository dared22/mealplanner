---
phase: 02-dashboard
plan: 01
type: execute
wave: 1
depends_on: ["01-03"]
files_modified:
  - Backend/fastapi_app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin can view dashboard metrics for users and recipes"
    - "Dashboard metrics include week-over-week growth percentages"
    - "System health status is reported from backend checks"
    - "Metrics refresh on page load via the API"
  artifacts:
    - path: "Backend/fastapi_app/main.py"
      provides: "Admin dashboard metrics endpoint"
      pattern: "/admin/dashboard/metrics"
    - path: "Backend/fastapi_app/main.py"
      provides: "Metrics response models and WoW helper"
      pattern: "DashboardMetricsResponse"
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "admin_user_dependency"
      via: "Depends(...)"
      pattern: "Depends\(admin_user_dependency\)"
    - from: "Backend/fastapi_app/main.py"
      to: "Database counts"
      via: "SQLAlchemy queries"
      pattern: "func.count"
---

<objective>
Expose an admin-only dashboard metrics API that returns user counts, recipe counts, week-over-week growth, and basic system health for the dashboard UI.

Purpose: Provide a single source of truth for admin dashboard analytics.
Output: `/admin/dashboard/metrics` endpoint and response models in the FastAPI app.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dashboard/02-CONTEXT.md

@Backend/fastapi_app/main.py
@Backend/fastapi_app/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define metrics response models and WoW helper</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
Add Pydantic models and a small helper for week-over-week calculations. Keep everything in `main.py` to match existing API patterns.

Models:
- `GrowthStat` with `total`, `current_week`, `previous_week`, `wow_percent`.
- `HealthStatus` with `status` ("healthy" | "degraded") and `checks` map.
- `DashboardMetricsResponse` with `users`, `recipes`, `health`.

Helper:
- `_wow_percent(current, previous)` returns:
  - `0` when `previous == 0` and `current == 0`
  - `100` when `previous == 0` and `current > 0`
  - `round(((current - previous) / previous) * 100)` otherwise

Avoid adding new dependencies; use existing typing imports.
  </action>
  <verify>
`python -m compileall Backend/fastapi_app/main.py` succeeds.
  </verify>
  <done>
- Response models and WoW helper exist in `Backend/fastapi_app/main.py`.
- Helper handles division-by-zero cases without crashing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement /admin/dashboard/metrics endpoint</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
Create `GET /admin/dashboard/metrics` and guard it with `Depends(admin_user_dependency)`.

Implementation details:
- Use the SQLAlchemy session already used elsewhere in `main.py`.
- Users:
  - `total`: count of all users.
  - `current_week`: users created in last 7 days (UTC).
  - `previous_week`: users created in 7 days before that.
  - `wow_percent`: `_wow_percent(current_week, previous_week)`.
- Recipes:
  - `total`: count of recipes.
  - `current_week` and `previous_week` set to 0 (recipes have no timestamps yet).
  - `wow_percent`: 0.
- Health:
  - Try the count queries; on success, set `status="healthy"` and `checks={"database": "ok"}`.
  - On any DB error, log and return zeros with `status="degraded"` and `checks={"database": "error"}` (do not raise).

Do not change existing endpoints or auth behavior outside this route.
  </action>
  <verify>
1) Confirm `/admin/dashboard/metrics` is defined with `Depends(admin_user_dependency)` in `Backend/fastapi_app/main.py`.
2) `python -m compileall Backend/fastapi_app/main.py` succeeds.
  </verify>
  <done>
- Admins can request `/admin/dashboard/metrics` and receive users/recipes/health data.
- Non-admins are blocked by `admin_user_dependency`.
- DB errors degrade health without crashing the API.
  </done>
</task>

</tasks>

<verification>
- `python -m compileall Backend/fastapi_app/main.py` passes.
- With an admin token, `/admin/dashboard/metrics` returns JSON containing `users`, `recipes`, and `health` keys.
</verification>

<success_criteria>
- Backend metrics endpoint is available and admin-protected.
- Week-over-week user growth is computed; recipe deltas are safely zeroed until timestamps exist.
- Health status reflects DB connectivity without API failure.
</success_criteria>

<output>
After completion, create `.planning/phases/02-dashboard/02-01-SUMMARY.md`
</output>
