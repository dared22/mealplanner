---
phase: 05-activity-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Backend/fastapi_app/models.py
  - Backend/fastapi_app/main.py
autonomous: true
must_haves:
  truths:
    - "Admin actions and user/system events are persisted as activity log entries with timestamps and statuses."
    - "Log entries capture actor type, actor identifier, action description, and status."
  artifacts:
    - path: "Backend/fastapi_app/models.py"
      provides: "ActivityLog SQLAlchemy model"
      contains: "class ActivityLog"
    - path: "Backend/fastapi_app/main.py"
      provides: "Activity log helper and event hooks"
      contains: "log_activity"
  key_links:
    - from: "Backend/fastapi_app/main.py"
      to: "ActivityLog"
      via: "db.add(ActivityLog(...))"
      pattern: "ActivityLog\\("
---

<objective>
Add a durable activity log model and baseline event recording for admin, user, and system actions.

Purpose: Enable audit-ready logging before exposing log data in the admin UI.
Output: ActivityLog model plus logging hooks in core backend flows.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Backend/fastapi_app/models.py
@Backend/fastapi_app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ActivityLog model</name>
  <files>Backend/fastapi_app/models.py</files>
  <action>
Define a new SQLAlchemy model ActivityLog with a UUID primary key, created_at timestamp, actor_type (admin/user/system), actor_id (nullable UUID), actor_label (nullable string), action_type (string), action_detail (text), status (success/warning/error/critical), and metadata (JSONB). Use server_default=func.now() for created_at and keep field sizes aligned with existing patterns.
  </action>
  <verify>python -m compileall Backend/fastapi_app</verify>
  <done>ActivityLog is a concrete model in models.py with the required fields and defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Record baseline activity events</name>
  <files>Backend/fastapi_app/main.py</files>
  <action>
Add a log_activity helper that creates ActivityLog rows with safe JSON metadata. Wire it into:
- user creation in optional_current_user (log user signup success with actor_type=user).
- update_admin_user_status (log admin suspension/activation with target user id).
- create_admin_recipe, update_admin_recipe, delete_admin_recipe (log admin recipe changes with target recipe id).
- _generate_plan_in_background success/error (log user activity and error status).
Add a global exception handler for unhandled exceptions to record system events (actor_type=system, status=critical) without crashing if logging fails.
Keep logging best-effort: never block the request if ActivityLog insert fails.
  </action>
  <verify>python -m compileall Backend/fastapi_app</verify>
  <done>Admin/user/system events are persisted in ActivityLog for the specified flows, and failures never break request handling.</done>
</task>

</tasks>

<verification>
ActivityLog rows are created for admin status updates, recipe changes, new user creation, and plan generation outcomes.
</verification>

<success_criteria>
ActivityLog model exists and baseline logging is wired into core admin/user/system flows.
</success_criteria>

<output>
After completion, create `.planning/phases/05-activity-logging/05-01-SUMMARY.md`
</output>
